<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿—å·¥åª’åˆå¹³å°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'sans': ['Inter', 'Noto Sans TC', 'system-ui', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen antialiased">
  
  <!-- GitHub Pages è¼‰å…¥æŒ‡ç¤ºå™¨ -->
  <div id="github-loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="spinner mx-auto mb-4"></div>
      <h2 class="text-xl font-semibold text-gray-900 mb-2">è¼‰å…¥å¿—å·¥åª’åˆå¹³å°</h2>
      <p class="text-gray-600">æ­£åœ¨å¾ Google Apps Script å–å¾—æœ€æ–°å…§å®¹...</p>
      <div class="mt-4 text-xs text-gray-500">
        GitHub Pages v2.1-static
      </div>
    </div>
  </div>

  <!-- ä¸»è¦å…§å®¹å®¹å™¨ -->
  <div id="main-content" class="hidden">
    <!-- å‹•æ…‹è¼‰å…¥çš„å…§å®¹æœƒå‡ºç¾åœ¨é€™è£¡ -->
  </div>

  <!-- éŒ¯èª¤é¡¯ç¤º -->
  <div id="error-display" class="hidden fixed inset-0 bg-gray-50 flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-6 text-center">
      <div class="text-red-500 text-6xl mb-4">âš ï¸</div>
      <h2 class="text-xl font-semibold text-gray-900 mb-2">è¼‰å…¥å¤±æ•—</h2>
      <p class="text-gray-600 mb-4" id="error-message">ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯æœå‹™</p>
      <button onclick="retryLoad()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
        é‡æ–°è¼‰å…¥
      </button>
      <div class="mt-4 text-xs text-gray-500">
        GitHub Pages v2.1-static
      </div>
    </div>
  </div>

  <script>
    // è¨­å®šä½ çš„ Google Apps Script Web App URL
    const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwH-L02JplBOP5Ezj04oDBbjM2oAaevdUM781tCfOR5d-lyB9fjdnDhyPRZcVB_RgQVGw/exec';
    
    // å…¨åŸŸè®Šæ•¸
    let currentData = null;
    
    // ä¸»è¦è¼‰å…¥å‡½æ•¸
    async function loadFromGAS() {
      try {
        console.log('é–‹å§‹å¾ GAS è¼‰å…¥å…§å®¹...');
        
        // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
        showLoading();
        
        // è¼‰å…¥å¿—å·¥éœ€æ±‚è³‡æ–™
        const dataResponse = await fetchGASData('data');
        if (dataResponse.success) {
          currentData = dataResponse.data;
          console.log('è³‡æ–™è¼‰å…¥æˆåŠŸ:', currentData.length, 'ç­†éœ€æ±‚');
        }
        
        // æ¸²æŸ“é é¢
        renderPage();
        
        // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨ï¼Œé¡¯ç¤ºä¸»å…§å®¹
        hideLoading();
        
      } catch (error) {
        console.error('è¼‰å…¥éŒ¯èª¤:', error);
        showError('è¼‰å…¥å¤±æ•—: ' + error.message);
      }
    }
    
    // å¾ GAS API å–å¾—è³‡æ–™
    async function fetchGASData(action, params = {}) {
      try {
        // å»ºæ§‹ URL
        const url = new URL(GAS_API_URL);
        url.searchParams.set('action', action);
        
        // æ·»åŠ é¡å¤–åƒæ•¸
        Object.keys(params).forEach(key => {
          url.searchParams.set(key, params[key]);
        });
        
        console.log('æ­£åœ¨å‘¼å« API:', url.toString());
        
        // ä½¿ç”¨ no-cors æ¨¡å¼ä½œç‚ºå‚™æ´
        let response;
        try {
          response = await fetch(url.toString(), {
            method: 'GET',
            mode: 'cors',
            headers: {
              'Accept': 'application/json',
            }
          });
        } catch (corsError) {
          console.warn('CORS è«‹æ±‚å¤±æ•—ï¼Œå˜—è©¦ JSONP:', corsError);
          // æ”¹ç”¨ JSONP
          return await fetchWithJSONP(url.toString());
        }
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('API å›æ‡‰:', data);
        return data;
        
      } catch (error) {
        console.error('fetchGASData éŒ¯èª¤:', error);
        // å˜—è©¦ JSONP ä½œç‚ºå‚™æ´
        if (!error.message.includes('JSONP')) {
          console.log('å˜—è©¦ JSONP å‚™æ´æ–¹æ¡ˆ');
          return await fetchWithJSONP(GAS_API_URL + '?action=' + action);
        }
        throw error;
      }
    }
    
    // JSONP å‚™æ´æ–¹æ¡ˆ
    function fetchWithJSONP(url) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        
        // å»ºç«‹ JSONP URL
        const jsonpUrl = url + (url.includes('?') ? '&' : '?') + 'callback=' + callbackName;
        
        // å»ºç«‹ script æ¨™ç±¤
        const script = document.createElement('script');
        script.src = jsonpUrl;
        
        // è¨­å®šå›èª¿å‡½æ•¸
        window[callbackName] = function(data) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(data);
        };
        
        // éŒ¯èª¤è™•ç†
        script.onerror = function() {
          delete window[callbackName];
          document.body.removeChild(script);
          reject(new Error('JSONP è«‹æ±‚å¤±æ•—'));
        };
        
        // è¶…æ™‚è™•ç†
        setTimeout(() => {
          if (window[callbackName]) {
            delete window[callbackName];
            document.body.removeChild(script);
            reject(new Error('JSONP è«‹æ±‚è¶…æ™‚'));
          }
        }, 10000);
        
        document.body.appendChild(script);
      });
    }
    
    // æ¸²æŸ“ä¸»é é¢
    function renderPage() {
      const container = document.getElementById('main-content');
      
      // å»ºç«‹å°èˆªåˆ—
      const nav = createNavigation();
      
      // å»ºç«‹ä¸»è¦å…§å®¹
      const main = createMainContent();
      
      // å»ºç«‹æ¨¡æ…‹æ¡†
      const modals = createModals();
      
      container.innerHTML = '';
      container.appendChild(nav);
      container.appendChild(main);
      container.appendChild(modals);
      
      // è¼‰å…¥ä¸¦é¡¯ç¤ºéœ€æ±‚åˆ—è¡¨
      displayData();
    }
    
    // å»ºç«‹å°èˆªåˆ—
    function createNavigation() {
      const nav = document.createElement('nav');
      nav.className = 'bg-white shadow-sm border-b';
      nav.innerHTML = `
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 py-3">
            <div class="flex items-center">
              <h1 class="text-xl sm:text-2xl font-bold text-gray-900">ğŸ¤ å¿—å·¥åª’åˆå¹³å°</h1>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
              <button onclick="openAddRequestModal()" 
                      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 sm:py-2 rounded-md font-medium transition-colors w-full sm:w-auto text-base sm:text-sm">
                âœ… æˆ‘éœ€è¦å¿—å·¥å¹«å¿™
              </button>
              <button onclick="openQueryModal()" 
                      class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 sm:py-2 rounded-md font-medium transition-colors w-full sm:w-auto text-base sm:text-sm">
                ğŸ” æŸ¥è©¢æˆ‘çš„éœ€æ±‚
              </button>
              <button onclick="refreshData()" 
                      class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 sm:py-2 rounded-md font-medium transition-colors w-full sm:w-auto text-base sm:text-sm">
                ğŸ”„ é‡æ–°æ•´ç†
              </button>
            </div>
          </div>
        </div>
      `;
      return nav;
    }
    
    // å»ºç«‹ä¸»è¦å…§å®¹å€
    function createMainContent() {
      const main = document.createElement('main');
      main.className = 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8';
      main.innerHTML = `
        <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-gray-900 mb-4">å¿—å·¥éœ€æ±‚åˆ—è¡¨</h2>
          <p class="text-lg text-gray-600">é€£çµéœ€è¦å¹«åŠ©çš„äººèˆ‡é¡˜æ„ä»˜å‡ºçš„å¿—å·¥</p>
        </div>
        <div id="content" class="grid grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-4 sm:gap-6">
          <div class="text-center py-16">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">è¼‰å…¥ä¸­,è«‹ç¨å€™..</p>
          </div>
        </div>
        
        <!-- GitHub Pages ç‰ˆæœ¬æ¨™è¨˜ -->
        <div class="fixed bottom-2 right-2 z-10 bg-black bg-opacity-20 text-white text-xs px-2 py-1 rounded">
          GitHub Pages v2.1-static
        </div>
      `;
      return main;
    }
    
    // å»ºç«‹æ¨¡æ…‹æ¡†å®¹å™¨
    function createModals() {
      const div = document.createElement('div');
      div.innerHTML = `
        <!-- æ–°å¢éœ€æ±‚æ¨¡æ…‹æ¡† -->
        <div id="addRequestModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
          <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
              <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-medium text-gray-900">æ–°å¢å¿—å·¥éœ€æ±‚</h3>
                  <button onclick="closeAddRequestModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="px-6 py-4">
                <div id="modalAlert" class="hidden mb-4 p-4 rounded-md"></div>
                <form id="requestForm" class="space-y-6">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      éœ€æ±‚åç¨± <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="name" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="ä¾‹å¦‚: æ¸…ç†å®¶åœ’ã€é™ªä¼´é•·è€…">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      éœ€è¦æ™‚é–“ <span class="text-red-500">*</span>
                    </label>
                    <input type="datetime-local" id="date" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      åœ°é»(ç¸£å¸‚/é„‰é®) <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="location" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="ä¾‹å¦‚: é«˜é›„å¸‚ã€å°å—å¸‚å®‰å—å€">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      è©³ç´°åœ°å€
                    </label>
                    <input type="text" id="address" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="ä¾‹å¦‚: XXè·¯XXè™Ÿ (å¯ä¸å¡«)">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      éœ€è¦å¿—å·¥äººæ•¸ <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="needed" required min="1" value="1"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      éœ€æ±‚è©³ç´°èªªæ˜ <span class="text-red-500">*</span>
                    </label>
                    <textarea id="description" required rows="4"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="è«‹è©³ç´°èªªæ˜éœ€è¦çš„å”åŠ©å…§å®¹"></textarea>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      è¯çµ¡äººå§“å <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="contact" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“åæˆ–ç¨±å‘¼">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      è¯çµ¡é›»è©± <span class="text-red-500">*</span>
                    </label>
                    <input type="tel" id="phone" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="ä¾‹å¦‚: 0912-345-678">
                  </div>
                </form>
              </div>
              <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <button type="button" onclick="closeAddRequestModal()" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                  å–æ¶ˆ
                </button>
                <button type="submit" form="requestForm" id="submitBtn"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                  æäº¤éœ€æ±‚
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- å¿—å·¥å ±åæ¨¡æ…‹æ¡† -->
        <div id="applyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
          <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
              <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-medium text-gray-900">å ±åå¿—å·¥æœå‹™</h3>
                  <button onclick="closeApplyModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="px-6 py-4">
                <div id="applyAlert" class="hidden mb-4 p-4 rounded-md"></div>
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                  <h4 class="font-medium text-gray-900 mb-3">ğŸ“‹ æ‚¨è¦å ±åçš„éœ€æ±‚</h4>
                  <div class="space-y-2 text-sm">
                    <div><span class="font-medium">éœ€æ±‚åç¨±ï¼š</span><span id="applyRequestName"></span></div>
                    <div><span class="font-medium">æœå‹™æ™‚é–“ï¼š</span><span id="applyRequestDate"></span></div>
                    <div><span class="font-medium">æœå‹™åœ°é»ï¼š</span><span id="applyRequestLocation"></span></div>
                    <div><span class="font-medium">è¯çµ¡äººï¼š</span><span id="applyRequestContact"></span></div>
                    <div><span class="font-medium">è¯çµ¡é›»è©±ï¼š</span><span id="applyRequestPhone"></span></div>
                  </div>
                </div>
                <form id="applyForm" class="space-y-4">
                  <input type="hidden" id="applyRequestId">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      æ‚¨çš„å§“å <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="volunteerName" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="è«‹è¼¸å…¥æ‚¨çš„çœŸå¯¦å§“å">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      è¯çµ¡é›»è©± <span class="text-red-500">*</span>
                    </label>
                    <input type="tel" id="volunteerPhone" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="ä¾‹å¦‚ï¼š0912-345-678">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      è¯çµ¡ä¿¡ç®±
                    </label>
                    <input type="email" id="volunteerEmail" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="ä¾‹å¦‚ï¼švolunteer@example.comï¼ˆé¸å¡«ï¼‰">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      å‚™è¨»èªªæ˜
                    </label>
                    <textarea id="volunteerNote" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="æœ‰ä»»ä½•æƒ³èªªçš„è©±æˆ–ç‰¹æ®Šéœ€æ±‚ï¼Œè«‹åœ¨æ­¤è¨»æ˜ï¼ˆé¸å¡«ï¼‰"></textarea>
                  </div>
                </form>
              </div>
              <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <button type="button" onclick="closeApplyModal()" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                  å–æ¶ˆ
                </button>
                <button type="submit" form="applyForm" id="applySubmitBtn"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                  ç¢ºèªå ±å
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- æŸ¥è©¢éœ€æ±‚æ¨¡æ…‹æ¡† -->
        <div id="queryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
          <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-lg w-full">
              <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                  <h3 class="text-lg font-medium text-gray-900">ğŸ” æŸ¥è©¢æˆ‘çš„éœ€æ±‚</h3>
                  <button onclick="closeQueryModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                </div>
              </div>
              <div class="px-6 py-4">
                <div id="queryAlert" class="hidden mb-4 p-4 rounded-md"></div>
                <div class="mb-6">
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    è«‹è¼¸å…¥æ‚¨çš„éœ€æ±‚ID
                  </label>
                  <input type="text" id="queryRequestId" 
                         class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                         placeholder="ä¾‹å¦‚ï¼šREQ1759308853376ABC">
                  <p class="mt-2 text-sm text-gray-500">é€™æ˜¯æ‚¨ç™¼å¸ƒéœ€æ±‚æ™‚ç²å¾—çš„IDï¼Œç”¨æ–¼æŸ¥çœ‹å ±åè€…è³‡æ–™</p>
                </div>
                <div id="queryResult" class="hidden">
                  <!-- æŸ¥è©¢çµæœå°‡åœ¨é€™è£¡é¡¯ç¤º -->
                </div>
              </div>
              <div class="px-6 py-4 border-t border-gray-200 flex justify-end space-x-3">
                <button type="button" onclick="closeQueryModal()" 
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md">
                  å–æ¶ˆ
                </button>
                <button type="button" onclick="queryRequest()" id="queryBtn"
                        class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md">
                  æŸ¥è©¢
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- éœ€æ±‚IDé¡¯ç¤ºæ¨¡æ…‹æ¡† -->
        <div id="requestIdModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50 overflow-y-auto">
          <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
              <div class="px-6 py-6 text-center">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <h3 class="text-xl font-bold text-gray-900 mb-4">éœ€æ±‚ç™¼å¸ƒæˆåŠŸï¼</h3>
                <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-6">
                  <div class="text-sm text-blue-800 mb-2 font-medium">æ‚¨çš„éœ€æ±‚ID</div>
                  <div class="bg-white border border-blue-300 rounded p-3 mb-3">
                    <code id="displayRequestId" class="text-lg font-mono text-blue-900 select-all"></code>
                  </div>
                  <button onclick="copyRequestId()" 
                          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                    ğŸ“‹ è¤‡è£½ID
                  </button>
                </div>
                <div class="text-left bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                  <div class="flex items-start">
                    <div class="text-yellow-600 mr-2">âš ï¸</div>
                    <div class="text-sm text-yellow-800">
                      <div class="font-medium mb-2">é‡è¦æé†’ï¼š</div>
                      <ul class="space-y-1">
                        <li>â€¢ è«‹å‹™å¿…è¤‡è£½ä¸¦å¦¥å–„ä¿å­˜æ­¤éœ€æ±‚ID</li>
                        <li>â€¢ é€™æ˜¯æŸ¥è©¢å ±åå¿—å·¥çš„å”¯ä¸€æ†‘è­‰</li>
                        <li>â€¢ å¦‚éºå¤±æ­¤IDå°‡ç„¡æ³•æŸ¥çœ‹å ±åè€…è³‡æ–™</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
              <div class="px-6 py-4 border-t border-gray-200 flex justify-center">
                <button type="button" onclick="closeRequestIdModal()" 
                        class="px-6 py-2 text-sm font-medium text-white bg-green-600 hover:bg-green-700 rounded-md">
                  æˆ‘å·²è¤‡è£½ï¼Œé—œé–‰
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      return div;
    }
    
    // é¡¯ç¤ºéœ€æ±‚è³‡æ–™
    function displayData() {
      const container = document.getElementById('content');
      
      if (!currentData || currentData.length === 0) {
        container.innerHTML = `
          <div class="text-center py-16 col-span-full">
            <div class="text-6xl mb-4">ğŸ“­</div>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">ç›®å‰æ²’æœ‰å¿—å·¥éœ€æ±‚</h2>
            <p class="text-gray-600 mb-6">å¦‚æœæ‚¨éœ€è¦å¿—å·¥å”åŠ©ï¼Œè«‹é»æ“Šä¸Šæ–¹ã€Œæˆ‘éœ€è¦å¿—å·¥å¹«å¿™ã€æŒ‰éˆ•</p>
            <button onclick="openAddRequestModal()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-medium transition-colors">
              ç«‹å³æ–°å¢éœ€æ±‚
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      // æŒ‰å»ºç«‹æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
      const sortedData = currentData.slice().sort((a, b) => {
        const timeA = parseTimeString(a[11]);
        const timeB = parseTimeString(b[11]);
        return timeB.getTime() - timeA.getTime();
      });
      
      sortedData.forEach(row => {
        const [id, name, date, location, address, needed, registered, description, contact, phone, status, createTime] = row;
        
        const card = createCard({
          id, name, date, location, address, needed, registered, 
          description, contact, phone, status, createTime
        });
        
        container.appendChild(card);
      });
    }
    
    // å»ºç«‹éœ€æ±‚å¡ç‰‡ (èˆ‡åŸ index.html ç›¸åŒçš„é‚è¼¯)
    function createCard(data) {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden sm:rounded-xl';
      
      const isFull = data.status === 'å·²é¡æ»¿' || (data.needed > 0 && data.registered >= data.needed);
      const progress = data.needed > 0 ? (data.registered / data.needed * 100) : 0;
      
      card.innerHTML = `
        <div class="p-5 sm:p-6">
          <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl sm:text-xl font-semibold text-gray-900 flex-1 leading-7">${data.name || 'æœªå‘½åéœ€æ±‚'}</h3>
            <span class="ml-2 px-3 py-1.5 rounded-full text-base sm:text-sm font-medium ${isFull ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
              ${isFull ? 'å·²é¡æ»¿' : 'æ‹›å‹Ÿä¸­'}
            </span>
          </div>
          
          <div class="space-y-2 sm:space-y-2.5 mb-4">
            <div class="flex items-center text-lg sm:text-sm text-gray-600 leading-relaxed">
              <span class="mr-3 text-2xl">ğŸ“…</span>
              <span class="font-medium mr-2">æ™‚é–“:</span>
              <span>${formatDate(data.date)}</span>
            </div>
            
            <div class="flex items-center text-lg sm:text-sm text-gray-600 leading-relaxed">
              <span class="mr-3 text-2xl">ğŸ“</span>
              <span class="font-medium mr-2">åœ°é»:</span>
              <span>${data.location || 'æœªæŒ‡å®š'}</span>
            </div>
            
            ${data.address ? `
            <div class="flex items-center text-lg sm:text-sm text-gray-600 leading-relaxed">
              <span class="mr-3 text-2xl">ğŸ </span>
              <span class="font-medium mr-2">åœ°å€:</span>
              <span>${data.address}</span>
            </div>
            ` : ''}
            
            ${data.createTime ? `
            <div class="flex items-center text-lg sm:text-sm text-gray-500 leading-relaxed">
              <span class="mr-3 text-2xl">â°</span>
              <span class="font-medium mr-2">ç™¼å¸ƒ:</span>
              <span>${formatRelativeTime(data.createTime)}</span>
            </div>
            ` : ''}
          </div>
          
          ${data.description ? `
          <div class="mb-4 p-4 bg-gray-50 rounded-md">
            <div class="text-lg sm:text-sm font-medium text-gray-700 mb-3">ğŸ“‹ éœ€æ±‚èªªæ˜</div>
            <div class="text-lg sm:text-sm text-gray-600 leading-relaxed">${data.description}</div>
          </div>
          ` : ''}
          
          <div class="mb-4">
            <div class="flex justify-between text-lg sm:text-sm text-gray-600 mb-3">
              <span class="font-medium">ğŸ‘¥ å ±åé€²åº¦</span>
              <span><strong>${data.registered || 0}</strong> / ${data.needed || 'ä¸é™'} äºº</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${Math.min(progress, 100)}%"></div>
            </div>
          </div>
          
          <div class="space-y-2 mb-4 text-lg sm:text-sm text-gray-600">
            <div class="flex items-center leading-relaxed">
              <span class="mr-3 text-2xl">ğŸ‘¤</span>
              <span class="font-medium mr-2">è¯çµ¡äºº:</span>
              <span>${data.contact || 'æœªæŒ‡å®š'}</span>
            </div>
            ${data.phone ? `
            <div class="flex items-center leading-relaxed">
              <span class="mr-3 text-2xl">ğŸ“</span>
              <span class="font-medium mr-2">é›»è©±:</span>
              <span>${data.phone}</span>
            </div>
            ` : ''}
          </div>
          
          <button class="w-full py-4 sm:py-2 px-4 rounded-lg font-medium transition-colors text-xl sm:text-sm ${isFull ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white'}" 
                  ${isFull ? 'disabled' : ''} 
                  onclick="openApplyModal('${data.id}', '${escapeHtml(data.name)}', '${escapeHtml(data.contact)}', '${data.phone}', '${escapeHtml(data.location)}', '${formatDate(data.date)}')">
            ${isFull ? 'ğŸš« å·²é¡æ»¿' : 'âœ‹ æˆ‘è¦å ±åç•¶å¿—å·¥'}
          </button>
        </div>
      `;
      
      return card;
    }
    
    // é‡æ–°æ•´ç†è³‡æ–™
    async function refreshData() {
      try {
        const dataResponse = await fetchGASData('data');
        if (dataResponse.success) {
          currentData = dataResponse.data;
          displayData();
        }
      } catch (error) {
        console.error('é‡æ–°æ•´ç†å¤±æ•—:', error);
        alert('é‡æ–°æ•´ç†å¤±æ•—: ' + error.message);
      }
    }
    
    // ============================================
    // æ¨¡æ…‹æ¡†æ§åˆ¶å‡½æ•¸
    // ============================================
    
    // æ–°å¢éœ€æ±‚æ¨¡æ…‹æ¡†
    function openAddRequestModal() {
      document.getElementById('addRequestModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      // è¨­å®šé è¨­æ™‚é–“
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      tomorrow.setHours(9, 0, 0, 0);
      
      const dateInput = document.getElementById('date');
      dateInput.value = tomorrow.toISOString().slice(0, 16);
      dateInput.min = new Date().toISOString().slice(0, 16);
    }
    
    function closeAddRequestModal() {
      document.getElementById('addRequestModal').classList.add('hidden');
      document.body.style.overflow = '';
      document.getElementById('requestForm').reset();
      hideModalAlert();
      setSubmitButtonLoading(false);
    }
    
    // å¿—å·¥å ±åæ¨¡æ…‹æ¡†
    function openApplyModal(requestId, requestName, contact, phone, location, date) {
      document.getElementById('applyModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      
      // å¡«å…¥éœ€æ±‚è³‡è¨Š
      document.getElementById('applyRequestId').value = requestId;
      document.getElementById('applyRequestName').textContent = requestName;
      document.getElementById('applyRequestDate').textContent = date;
      document.getElementById('applyRequestLocation').textContent = location;
      document.getElementById('applyRequestContact').textContent = contact;
      document.getElementById('applyRequestPhone').textContent = phone;
      
      // æ¸…ç©ºè¡¨å–®
      document.getElementById('applyForm').reset();
      hideApplyAlert();
    }
    
    function closeApplyModal() {
      document.getElementById('applyModal').classList.add('hidden');
      document.body.style.overflow = '';
      document.getElementById('applyForm').reset();
      hideApplyAlert();
      setApplyButtonLoading(false);
    }
    
    // æŸ¥è©¢éœ€æ±‚æ¨¡æ…‹æ¡†
    function openQueryModal() {
      document.getElementById('queryModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      document.getElementById('queryRequestId').value = '';
      document.getElementById('queryResult').classList.add('hidden');
      hideQueryAlert();
    }
    
    function closeQueryModal() {
      document.getElementById('queryModal').classList.add('hidden');
      document.body.style.overflow = '';
      document.getElementById('queryRequestId').value = '';
      document.getElementById('queryResult').classList.add('hidden');
      hideQueryAlert();
    }
    
    // éœ€æ±‚IDé¡¯ç¤ºæ¨¡æ…‹æ¡†
    function showRequestIdModal(requestId) {
      document.getElementById('requestIdModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      document.getElementById('displayRequestId').textContent = requestId;
    }
    
    function closeRequestIdModal() {
      document.getElementById('requestIdModal').classList.add('hidden');
      document.body.style.overflow = '';
    }
    
    // ============================================
    // è¡¨å–®è™•ç†å‡½æ•¸
    // ============================================
    
    // æ–°å¢éœ€æ±‚è¡¨å–®æäº¤
    async function submitNewRequest(formData) {
      try {
        const response = await fetchGASData('add', { 
          data: JSON.stringify(formData) 
        });
        return response;
      } catch (error) {
        throw new Error('æäº¤å¤±æ•—: ' + error.message);
      }
    }
    
    // å¿—å·¥å ±åè¡¨å–®æäº¤
    async function submitVolunteerApplication(applyData) {
      try {
        const response = await fetchGASData('apply', { 
          data: JSON.stringify(applyData) 
        });
        return response;
      } catch (error) {
        throw new Error('å ±åå¤±æ•—: ' + error.message);
      }
    }
    
    // æŸ¥è©¢éœ€æ±‚
    async function queryRequest() {
      const requestId = document.getElementById('queryRequestId').value.trim();
      
      if (!requestId) {
        showQueryAlert('è«‹è¼¸å…¥éœ€æ±‚ID', 'error');
        return;
      }
      
      // ç°¡å–®çš„æ ¼å¼æª¢æŸ¥
      if (!requestId.startsWith('REQ') || requestId.length < 10) {
        showQueryAlert('éœ€æ±‚IDæ ¼å¼ä¸æ­£ç¢ºï¼Œæ‡‰è©²ä»¥REQé–‹é ­', 'error');
        return;
      }
      
      // è¨­å®šè¼‰å…¥ç‹€æ…‹
      const queryBtn = document.getElementById('queryBtn');
      queryBtn.disabled = true;
      queryBtn.innerHTML = `
        <div class="flex items-center justify-center">
          <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
          æŸ¥è©¢ä¸­...
        </div>
      `;
      
      try {
        const result = await fetchGASData('query', { requestId: requestId });
        queryBtn.disabled = false;
        queryBtn.innerHTML = 'æŸ¥è©¢';
        
        if (result && result.success !== false) {
          displayQueryResult(result);
        } else {
          showQueryAlert(result ? result.message : 'æŸ¥è©¢å¤±æ•—', 'error');
        }
      } catch (error) {
        queryBtn.disabled = false;
        queryBtn.innerHTML = 'æŸ¥è©¢';
        console.error('æŸ¥è©¢éŒ¯èª¤:', error);
        showQueryAlert('æŸ¥è©¢å¤±æ•—ï¼š' + error.message, 'error');
      }
    }
    
    // é¡¯ç¤ºæŸ¥è©¢çµæœ
    function displayQueryResult(result) {
      const container = document.getElementById('queryResult');
      
      if (!result.applications || result.applications.length === 0) {
        container.innerHTML = `
          <div class="text-center py-6 bg-gray-50 rounded-lg">
            <div class="text-gray-400 text-4xl mb-3">ğŸ‘¥</div>
            <p class="text-gray-600">ç›®å‰é‚„æ²’æœ‰äººå ±åæ­¤éœ€æ±‚</p>
            <p class="text-gray-500 text-sm mt-1">ç­‰å¾…å¿—å·¥å ±åä¸­...</p>
          </div>
        `;
        container.classList.remove('hidden');
        return;
      }
      
      // é¡¯ç¤ºå ±åè€…æ¸…å–®
      let html = `
        <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
          <div class="flex items-center">
            <div class="text-green-600 mr-2">âœ…</div>
            <div class="text-green-800">
              <div class="font-medium">æ‰¾åˆ°æ‚¨çš„éœ€æ±‚ï¼</div>
              <div class="text-sm">å…±æœ‰ <strong>${result.applications.length}</strong> ä½å¿—å·¥å ±å</div>
            </div>
          </div>
        </div>
        
        <div class="space-y-3 max-h-64 overflow-y-auto">
      `;
      
      result.applications.forEach((app, index) => {
        const [applicationId, requestId, volunteerName, volunteerPhone, volunteerEmail, volunteerNote, applicationTime, status] = app;
        
        html += `
          <div class="bg-gray-50 rounded-lg p-3 border border-gray-200">
            <div class="flex justify-between items-start mb-2">
              <h6 class="font-medium text-gray-900">ğŸ‘¤ ${volunteerName}</h6>
              <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">${status}</span>
            </div>
            
            <div class="space-y-1 text-sm">
              <div class="flex items-center">
                <span class="w-12 text-gray-600">ğŸ“</span>
                <span class="font-medium mr-2">${volunteerPhone}</span>
                <button onclick="copyToClipboard('${volunteerPhone}')" 
                        class="text-blue-600 hover:text-blue-800 text-xs">
                  è¤‡è£½
                </button>
              </div>
              
              ${volunteerEmail ? `
              <div class="flex items-center">
                <span class="w-12 text-gray-600">ğŸ“§</span>
                <span class="mr-2">${volunteerEmail}</span>
                <button onclick="copyToClipboard('${volunteerEmail}')" 
                        class="text-blue-600 hover:text-blue-800 text-xs">
                  è¤‡è£½
                </button>
              </div>
              ` : ''}
              
              <div class="flex items-center">
                <span class="w-12 text-gray-600">â°</span>
                <span class="text-gray-700">${formatRelativeTime(applicationTime)}</span>
              </div>
              
              ${volunteerNote ? `
              <div class="mt-2 pt-2 border-t border-gray-200">
                <div class="text-gray-600 text-xs mb-1">ğŸ’¬ å‚™è¨»ï¼š</div>
                <div class="text-gray-700">${volunteerNote}</div>
              </div>
              ` : ''}
            </div>
          </div>
        `;
      });
      
      html += `
        </div>
        <div class="mt-4 p-3 bg-blue-50 rounded-lg">
          <div class="text-blue-900 text-sm">
            <div class="font-medium mb-1">ğŸ“‹ è¯çµ¡æé†’</div>
            <div>è«‹ä¸»å‹•è¯çµ¡å ±åçš„å¿—å·¥ï¼Œç¢ºèªæœå‹™æ™‚é–“å’Œåœ°é»</div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
      container.classList.remove('hidden');
    }
    
    // å·¥å…·å‡½æ•¸
    function showLoading() {
      document.getElementById('github-loading').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
      document.getElementById('error-display').classList.add('hidden');
    }
    
    function hideLoading() {
      document.getElementById('github-loading').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
    }
    
    function showError(message) {
      document.getElementById('error-message').textContent = message;
      document.getElementById('github-loading').classList.add('hidden');
      document.getElementById('main-content').classList.add('hidden');
      document.getElementById('error-display').classList.remove('hidden');
    }
    
    function retryLoad() {
      loadFromGAS();
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸ (èˆ‡åŸç‰ˆç›¸åŒ)
    function formatDate(date) {
      try {
        if (!date) return 'æœªæŒ‡å®š';
        let d = date;
        if (!(d instanceof Date)) {
          if (typeof date === 'string') {
            d = new Date(date);
          } else {
            d = new Date(date);
          }
        }
        if (isNaN(d.getTime())) return String(date);
        return d.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: true,
          timeZone: 'Asia/Taipei'
        });
      } catch (e) {
        console.error('formatDate éŒ¯èª¤:', e, date);
        return String(date);
      }
    }
    
    // è§£ææ™‚é–“å­—ä¸² (èˆ‡åŸç‰ˆç›¸åŒ)
    function parseTimeString(timeString) {
      if (!timeString) return new Date(0);
      try {
        if (timeString instanceof Date) {
          return timeString;
        }
        if (typeof timeString === 'string') {
          if (timeString.includes('ä¸Šåˆ') || timeString.includes('ä¸‹åˆ')) {
            let convertedTime = timeString
              .replace('ä¸Šåˆ', 'AM')
              .replace('ä¸‹åˆ', 'PM')
              .replace(/(\d{4})\/(\d{1,2})\/(\d{1,2})/, '$1-$2-$3');
            return new Date(convertedTime);
          } else {
            return new Date(timeString);
          }
        }
        return new Date(0);
      } catch (error) {
        console.error('æ™‚é–“è§£æéŒ¯èª¤:', error, timeString);
        return new Date(0);
      }
    }
    
    // æ ¼å¼åŒ–ç›¸å°æ™‚é–“ (ç°¡åŒ–ç‰ˆ)
    function formatRelativeTime(timeString) {
      try {
        const targetDate = parseTimeString(timeString);
        const now = new Date();
        const diffMs = now.getTime() - targetDate.getTime();
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffMins < 1) return 'å‰›å‰›';
        if (diffMins < 60) return diffMins + 'åˆ†é˜å‰';
        if (diffHours < 24) return diffHours + 'å°æ™‚å‰';
        if (diffDays < 30) return diffDays + 'å¤©å‰';
        
        return formatDate(targetDate);
      } catch (error) {
        return formatDate(timeString);
      }
    }
    
    // æ¸¬è©¦ API é€£æ¥
    async function testAPIConnection() {
      console.log('æ¸¬è©¦ API é€£æ¥...');
      console.log('GAS_API_URL:', GAS_API_URL);
      
      // æ¸¬è©¦ä¸åŒçš„é€£æ¥æ–¹å¼
      const testMethods = [
        {
          name: 'CORS fetch',
          test: async () => {
            const response = await fetch(GAS_API_URL + '?action=data', {
              method: 'GET',
              mode: 'cors'
            });
            return await response.json();
          }
        },
        {
          name: 'No-CORS fetch',
          test: async () => {
            const response = await fetch(GAS_API_URL + '?action=data', {
              method: 'GET',
              mode: 'no-cors'
            });
            return { success: true, note: 'no-cors æ¨¡å¼ï¼Œç„¡æ³•è®€å–å›æ‡‰å…§å®¹' };
          }
        },
        {
          name: 'JSONP',
          test: async () => {
            return await fetchWithJSONP(GAS_API_URL + '?action=data');
          }
        },
        {
          name: 'Simple GET (ç„¡åƒæ•¸)',
          test: async () => {
            const response = await fetch(GAS_API_URL);
            return { success: true, note: 'åŸºæœ¬é€£æ¥æˆåŠŸ' };
          }
        }
      ];
      
      for (const method of testMethods) {
        try {
          console.log(`å˜—è©¦ ${method.name}...`);
          const result = await method.test();
          console.log(`${method.name} æˆåŠŸ:`, result);
          
          if (result && (result.success !== false)) {
            console.log('æ‰¾åˆ°å¯ç”¨çš„é€£æ¥æ–¹å¼:', method.name);
            return { method: method.name, data: result };
          }
        } catch (error) {
          console.warn(`${method.name} å¤±æ•—:`, error.message);
        }
      }
      
      throw new Error('æ‰€æœ‰é€£æ¥æ–¹å¼éƒ½å¤±æ•—');
    }
    
    // ============================================
    // å·¥å…·å‡½æ•¸èˆ‡äº‹ä»¶ç›£è½å™¨
    // ============================================
    
    // HTML è½‰ç¾©å‡½æ•¸
    function escapeHtml(unsafe) {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    // è¤‡è£½åˆ°å‰ªè²¼ç°¿
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(function() {
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-md z-50';
        notification.textContent = 'å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿';
        document.body.appendChild(notification);
        
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 2000);
      }).catch(function(err) {
        console.error('è¤‡è£½å¤±æ•—:', err);
        alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
      });
    }
    
    // è¤‡è£½éœ€æ±‚ID
    function copyRequestId() {
      const requestId = document.getElementById('displayRequestId').textContent;
      copyToClipboard(requestId);
    }
    
    // æç¤ºè¨Šæ¯é¡¯ç¤ºå‡½æ•¸
    function showModalAlert(message, type) {
      const alert = document.getElementById('modalAlert');
      alert.textContent = message;
      alert.className = `mb-4 p-4 rounded-md ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
      alert.classList.remove('hidden');
      
      if (type === 'error') {
        setTimeout(() => hideModalAlert(), 5000);
      }
    }
    
    function hideModalAlert() {
      document.getElementById('modalAlert').classList.add('hidden');
    }
    
    function showApplyAlert(message, type) {
      const alert = document.getElementById('applyAlert');
      alert.textContent = message;
      alert.className = `mb-4 p-4 rounded-md ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
      alert.classList.remove('hidden');
      
      if (type === 'error') {
        setTimeout(() => hideApplyAlert(), 5000);
      }
    }
    
    function hideApplyAlert() {
      document.getElementById('applyAlert').classList.add('hidden');
    }
    
    function showQueryAlert(message, type) {
      const alert = document.getElementById('queryAlert');
      alert.textContent = message;
      alert.className = `mb-4 p-4 rounded-md ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
      alert.classList.remove('hidden');
      
      if (type === 'error') {
        setTimeout(() => hideQueryAlert(), 5000);
      }
    }
    
    function hideQueryAlert() {
      document.getElementById('queryAlert').classList.add('hidden');
    }
    
    // æŒ‰éˆ•è¼‰å…¥ç‹€æ…‹æ§åˆ¶
    function setSubmitButtonLoading(loading) {
      const submitBtn = document.getElementById('submitBtn');
      if (loading) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
          <div class="flex items-center justify-center">
            <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
            æäº¤ä¸­...
          </div>
        `;
      } else {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'æäº¤éœ€æ±‚';
      }
    }
    
    function setApplyButtonLoading(loading) {
      const submitBtn = document.getElementById('applySubmitBtn');
      if (loading) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
          <div class="flex items-center justify-center">
            <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"></div>
            å ±åä¸­...
          </div>
        `;
      } else {
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'ç¢ºèªå ±å';
      }
    }
    
    // é é¢è¼‰å…¥å®Œæˆå¾Œé–‹å§‹
    document.addEventListener('DOMContentLoaded', function() {
      // æª¢æŸ¥æ˜¯å¦æœ‰è¨­å®š API URL
      if (GAS_API_URL === 'YOUR_GAS_WEB_APP_URL_HERE') {
        showError('è«‹å…ˆè¨­å®š GAS_API_URL\n\næ­¥é©Ÿï¼š\n1. éƒ¨ç½²ä½ çš„ Google Apps Script ç‚º Web æ‡‰ç”¨ç¨‹å¼\n2. è¤‡è£½éƒ¨ç½²ç¶²å€\n3. åœ¨ç¨‹å¼ç¢¼ç¬¬ 47 è¡Œæ›¿æ› YOUR_GAS_WEB_APP_URL_HERE\n4. é‡æ–°ä¸Šå‚³åˆ° GitHub');
        return;
      }
      
      // å…ˆæ¸¬è©¦ API é€£æ¥
      testAPIConnection()
        .then(result => {
          console.log('API é€£æ¥æ¸¬è©¦æˆåŠŸ:', result);
          loadFromGAS();
        })
        .catch(error => {
          console.error('API é€£æ¥æ¸¬è©¦å¤±æ•—:', error);
          showError('ç„¡æ³•é€£æ¥åˆ° Google Apps Script API\n\nå¯èƒ½åŸå› ï¼š\n1. GAS_API_URL è¨­å®šéŒ¯èª¤\n2. Google Apps Script æœªæ­£ç¢ºéƒ¨ç½²\n3. æ¬Šé™è¨­å®šå•é¡Œ\n\nè«‹æª¢æŸ¥ï¼š\n- éƒ¨ç½²æ™‚é¸æ“‡ã€Œä»»ä½•äººã€å­˜å–æ¬Šé™\n- URL æ˜¯å¦æ­£ç¢º\n- æ˜¯å¦å·²ä¸Šå‚³ api.gs æª”æ¡ˆ\n\néŒ¯èª¤ï¼š' + error.message);
        });
        
      // ============================================
      // è¡¨å–®äº‹ä»¶ç›£è½å™¨
      // ============================================
      
      // æ–°å¢éœ€æ±‚è¡¨å–®
      const requestForm = document.getElementById('requestForm');
      if (requestForm) {
        requestForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // é˜²æ­¢é‡è¤‡æäº¤
          const submitBtn = document.getElementById('submitBtn');
          if (submitBtn.disabled) return;
          
          // æ”¶é›†è¡¨å–®è³‡æ–™
          const formData = {
            name: document.getElementById('name').value.trim(),
            date: document.getElementById('date').value,
            location: document.getElementById('location').value.trim(),
            address: document.getElementById('address').value.trim(),
            needed: parseInt(document.getElementById('needed').value),
            description: document.getElementById('description').value.trim(),
            contact: document.getElementById('contact').value.trim(),
            phone: document.getElementById('phone').value.trim()
          };
          
          // é©—è­‰
          if (!formData.name || !formData.date || !formData.location || 
              !formData.description || !formData.contact || !formData.phone) {
            showModalAlert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
            return;
          }
          
          if (formData.needed < 1) {
            showModalAlert('å¿—å·¥äººæ•¸å¿…é ˆå¤§æ–¼ 0', 'error');
            return;
          }
          
          // è¨­å®šè¼‰å…¥ç‹€æ…‹
          setSubmitButtonLoading(true);
          
          try {
            const result = await submitNewRequest(formData);
            
            if (result.success) {
              showModalAlert('éœ€æ±‚æ–°å¢æˆåŠŸï¼æ­£åœ¨æ›´æ–°è³‡æ–™...', 'success');
              
              // 1ç§’å¾Œé—œé–‰æ¨¡æ…‹æ¡†ä¸¦é¡¯ç¤ºéœ€æ±‚ID
              setTimeout(() => {
                closeAddRequestModal();
                showRequestIdModal(result.requestId);
                // 2ç§’å¾Œé‡æ–°è¼‰å…¥è³‡æ–™
                setTimeout(() => {
                  refreshData();
                }, 2000);
              }, 1000);
            } else {
              setSubmitButtonLoading(false);
              showModalAlert('éŒ¯èª¤ï¼š' + result.message, 'error');
            }
          } catch (error) {
            setSubmitButtonLoading(false);
            showModalAlert('æäº¤å¤±æ•—ï¼š' + error.message, 'error');
            console.error(error);
          }
        });
      }
      
      // å¿—å·¥å ±åè¡¨å–®
      const applyForm = document.getElementById('applyForm');
      if (applyForm) {
        applyForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          // é˜²æ­¢é‡è¤‡æäº¤
          const submitBtn = document.getElementById('applySubmitBtn');
          if (submitBtn.disabled) return;
          
          // æ”¶é›†è¡¨å–®è³‡æ–™
          const applyData = {
            requestId: document.getElementById('applyRequestId').value,
            volunteerName: document.getElementById('volunteerName').value.trim(),
            volunteerPhone: document.getElementById('volunteerPhone').value.trim(),
            volunteerEmail: document.getElementById('volunteerEmail').value.trim(),
            volunteerNote: document.getElementById('volunteerNote').value.trim()
          };
          
          // é©—è­‰å¿…å¡«æ¬„ä½
          if (!applyData.volunteerName || !applyData.volunteerPhone) {
            showApplyAlert('è«‹å¡«å¯«å§“åå’Œè¯çµ¡é›»è©±', 'error');
            return;
          }
          
          // é©—è­‰é›»è©±æ ¼å¼ï¼ˆç°¡å–®æª¢æŸ¥ï¼‰
          if (!/^[\d\-\+\(\)\s]+$/.test(applyData.volunteerPhone)) {
            showApplyAlert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é›»è©±è™Ÿç¢¼', 'error');
            return;
          }
          
          // è¨­å®šè¼‰å…¥ç‹€æ…‹
          setApplyButtonLoading(true);
          
          try {
            const result = await submitVolunteerApplication(applyData);
            
            if (result.success) {
              showApplyAlert('å ±åæˆåŠŸï¼éœ€æ±‚ç™¼å¸ƒè€…æœƒç›¡å¿«èˆ‡æ‚¨è¯ç¹«ã€‚', 'success');
              
              // 2ç§’å¾Œé—œé–‰æ¨¡æ…‹æ¡†ä¸¦é‡æ–°è¼‰å…¥è³‡æ–™
              setTimeout(() => {
                closeApplyModal();
                refreshData();
              }, 2000);
            } else {
              setApplyButtonLoading(false);
              showApplyAlert('å ±åå¤±æ•—ï¼š' + result.message, 'error');
            }
          } catch (error) {
            setApplyButtonLoading(false);
            showApplyAlert('å ±åå¤±æ•—ï¼š' + error.message, 'error');
            console.error(error);
          }
        });
      }
    });
  </script>
</body>
</html>
