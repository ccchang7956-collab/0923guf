<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¿—å·¥åª’åˆå¹³å°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'sans': ['Inter', 'Noto Sans TC', 'system-ui', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen antialiased">
  
  <!-- GitHub Pages è¼‰å…¥æŒ‡ç¤ºå™¨ -->
  <div id="github-loading" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
    <div class="text-center">
      <div class="spinner mx-auto mb-4"></div>
      <h2 class="text-xl font-semibold text-gray-900 mb-2">è¼‰å…¥å¿—å·¥åª’åˆå¹³å°</h2>
      <p class="text-gray-600">æ­£åœ¨å¾ Google Apps Script å–å¾—æœ€æ–°å…§å®¹...</p>
      <div class="mt-4 text-xs text-gray-500">
        GitHub Pages v2.1-static
      </div>
    </div>
  </div>

  <!-- ä¸»è¦å…§å®¹å®¹å™¨ -->
  <div id="main-content" class="hidden">
    <!-- å‹•æ…‹è¼‰å…¥çš„å…§å®¹æœƒå‡ºç¾åœ¨é€™è£¡ -->
  </div>

  <!-- éŒ¯èª¤é¡¯ç¤º -->
  <div id="error-display" class="hidden fixed inset-0 bg-gray-50 flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white rounded-lg shadow-lg p-6 text-center">
      <div class="text-red-500 text-6xl mb-4">âš ï¸</div>
      <h2 class="text-xl font-semibold text-gray-900 mb-2">è¼‰å…¥å¤±æ•—</h2>
      <p class="text-gray-600 mb-4" id="error-message">ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯æœå‹™</p>
      <button onclick="retryLoad()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
        é‡æ–°è¼‰å…¥
      </button>
      <div class="mt-4 text-xs text-gray-500">
        GitHub Pages v2.1-static
      </div>
    </div>
  </div>

  <script>
    // è¨­å®šä½ çš„ Google Apps Script Web App URL
    const GAS_API_URL = 'YOUR_GAS_WEB_APP_URL_HERE';
    
    // å…¨åŸŸè®Šæ•¸
    let currentData = null;
    
    // ä¸»è¦è¼‰å…¥å‡½æ•¸
    async function loadFromGAS() {
      try {
        console.log('é–‹å§‹å¾ GAS è¼‰å…¥å…§å®¹...');
        
        // é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
        showLoading();
        
        // è¼‰å…¥å¿—å·¥éœ€æ±‚è³‡æ–™
        const dataResponse = await fetchGASData('data');
        if (dataResponse.success) {
          currentData = dataResponse.data;
          console.log('è³‡æ–™è¼‰å…¥æˆåŠŸ:', currentData.length, 'ç­†éœ€æ±‚');
        }
        
        // æ¸²æŸ“é é¢
        renderPage();
        
        // éš±è—è¼‰å…¥æŒ‡ç¤ºå™¨ï¼Œé¡¯ç¤ºä¸»å…§å®¹
        hideLoading();
        
      } catch (error) {
        console.error('è¼‰å…¥éŒ¯èª¤:', error);
        showError('è¼‰å…¥å¤±æ•—: ' + error.message);
      }
    }
    
    // å¾ GAS API å–å¾—è³‡æ–™
    async function fetchGASData(action, params = {}) {
      const url = new URL(GAS_API_URL);
      url.searchParams.set('action', action);
      
      // æ·»åŠ é¡å¤–åƒæ•¸
      Object.keys(params).forEach(key => {
        url.searchParams.set(key, params[key]);
      });
      
      const response = await fetch(url.toString());
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      return await response.json();
    }
    
    // æ¸²æŸ“ä¸»é é¢
    function renderPage() {
      const container = document.getElementById('main-content');
      
      // å»ºç«‹å°èˆªåˆ—
      const nav = createNavigation();
      
      // å»ºç«‹ä¸»è¦å…§å®¹
      const main = createMainContent();
      
      // å»ºç«‹æ¨¡æ…‹æ¡†
      const modals = createModals();
      
      container.innerHTML = '';
      container.appendChild(nav);
      container.appendChild(main);
      container.appendChild(modals);
      
      // è¼‰å…¥ä¸¦é¡¯ç¤ºéœ€æ±‚åˆ—è¡¨
      displayData();
    }
    
    // å»ºç«‹å°èˆªåˆ—
    function createNavigation() {
      const nav = document.createElement('nav');
      nav.className = 'bg-white shadow-sm border-b';
      nav.innerHTML = `
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 py-3">
            <div class="flex items-center">
              <h1 class="text-xl sm:text-2xl font-bold text-gray-900">ğŸ¤ å¿—å·¥åª’åˆå¹³å°</h1>
            </div>
            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full sm:w-auto">
              <button onclick="openAddRequestModal()" 
                      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 sm:py-2 rounded-md font-medium transition-colors w-full sm:w-auto text-base sm:text-sm">
                âœ… æˆ‘éœ€è¦å¿—å·¥å¹«å¿™
              </button>
              <button onclick="openQueryModal()" 
                      class="bg-green-600 hover:bg-green-700 text-white px-4 py-3 sm:py-2 rounded-md font-medium transition-colors w-full sm:w-auto text-base sm:text-sm">
                ğŸ” æŸ¥è©¢æˆ‘çš„éœ€æ±‚
              </button>
              <button onclick="refreshData()" 
                      class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 sm:py-2 rounded-md font-medium transition-colors w-full sm:w-auto text-base sm:text-sm">
                ğŸ”„ é‡æ–°æ•´ç†
              </button>
            </div>
          </div>
        </div>
      `;
      return nav;
    }
    
    // å»ºç«‹ä¸»è¦å…§å®¹å€
    function createMainContent() {
      const main = document.createElement('main');
      main.className = 'max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8';
      main.innerHTML = `
        <div class="text-center mb-8">
          <h2 class="text-3xl font-bold text-gray-900 mb-4">å¿—å·¥éœ€æ±‚åˆ—è¡¨</h2>
          <p class="text-lg text-gray-600">é€£çµéœ€è¦å¹«åŠ©çš„äººèˆ‡é¡˜æ„ä»˜å‡ºçš„å¿—å·¥</p>
        </div>
        <div id="content" class="grid grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-4 sm:gap-6">
          <div class="text-center py-16">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-gray-600">è¼‰å…¥ä¸­,è«‹ç¨å€™..</p>
          </div>
        </div>
        
        <!-- GitHub Pages ç‰ˆæœ¬æ¨™è¨˜ -->
        <div class="fixed bottom-2 right-2 z-10 bg-black bg-opacity-20 text-white text-xs px-2 py-1 rounded">
          GitHub Pages v2.1-static
        </div>
      `;
      return main;
    }
    
    // å»ºç«‹æ¨¡æ…‹æ¡†å®¹å™¨
    function createModals() {
      const div = document.createElement('div');
      div.innerHTML = `
        <!-- é€™è£¡æœƒå‹•æ…‹åŠ å…¥å„ç¨®æ¨¡æ…‹æ¡† -->
        <div id="modal-container"></div>
      `;
      return div;
    }
    
    // é¡¯ç¤ºéœ€æ±‚è³‡æ–™
    function displayData() {
      const container = document.getElementById('content');
      
      if (!currentData || currentData.length === 0) {
        container.innerHTML = `
          <div class="text-center py-16 col-span-full">
            <div class="text-6xl mb-4">ğŸ“­</div>
            <h2 class="text-2xl font-bold text-gray-900 mb-4">ç›®å‰æ²’æœ‰å¿—å·¥éœ€æ±‚</h2>
            <p class="text-gray-600 mb-6">å¦‚æœæ‚¨éœ€è¦å¿—å·¥å”åŠ©ï¼Œè«‹é»æ“Šä¸Šæ–¹ã€Œæˆ‘éœ€è¦å¿—å·¥å¹«å¿™ã€æŒ‰éˆ•</p>
            <button onclick="openAddRequestModal()" 
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-md font-medium transition-colors">
              ç«‹å³æ–°å¢éœ€æ±‚
            </button>
          </div>
        `;
        return;
      }
      
      container.innerHTML = '';
      
      // æŒ‰å»ºç«‹æ™‚é–“æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
      const sortedData = currentData.slice().sort((a, b) => {
        const timeA = parseTimeString(a[11]);
        const timeB = parseTimeString(b[11]);
        return timeB.getTime() - timeA.getTime();
      });
      
      sortedData.forEach(row => {
        const [id, name, date, location, address, needed, registered, description, contact, phone, status, createTime] = row;
        
        const card = createCard({
          id, name, date, location, address, needed, registered, 
          description, contact, phone, status, createTime
        });
        
        container.appendChild(card);
      });
    }
    
    // å»ºç«‹éœ€æ±‚å¡ç‰‡ (èˆ‡åŸ index.html ç›¸åŒçš„é‚è¼¯)
    function createCard(data) {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 overflow-hidden sm:rounded-xl';
      
      const isFull = data.status === 'å·²é¡æ»¿' || (data.needed > 0 && data.registered >= data.needed);
      const progress = data.needed > 0 ? (data.registered / data.needed * 100) : 0;
      
      card.innerHTML = `
        <div class="p-5 sm:p-6">
          <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl sm:text-xl font-semibold text-gray-900 flex-1 leading-7">${data.name || 'æœªå‘½åéœ€æ±‚'}</h3>
            <span class="ml-2 px-3 py-1.5 rounded-full text-base sm:text-sm font-medium ${isFull ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">
              ${isFull ? 'å·²é¡æ»¿' : 'æ‹›å‹Ÿä¸­'}
            </span>
          </div>
          
          <div class="space-y-2 sm:space-y-2.5 mb-4">
            <div class="flex items-center text-lg sm:text-sm text-gray-600 leading-relaxed">
              <span class="mr-3 text-2xl">ğŸ“…</span>
              <span class="font-medium mr-2">æ™‚é–“:</span>
              <span>${formatDate(data.date)}</span>
            </div>
            
            <div class="flex items-center text-lg sm:text-sm text-gray-600 leading-relaxed">
              <span class="mr-3 text-2xl">ğŸ“</span>
              <span class="font-medium mr-2">åœ°é»:</span>
              <span>${data.location || 'æœªæŒ‡å®š'}</span>
            </div>
            
            ${data.address ? `
            <div class="flex items-center text-lg sm:text-sm text-gray-600 leading-relaxed">
              <span class="mr-3 text-2xl">ğŸ </span>
              <span class="font-medium mr-2">åœ°å€:</span>
              <span>${data.address}</span>
            </div>
            ` : ''}
            
            ${data.createTime ? `
            <div class="flex items-center text-lg sm:text-sm text-gray-500 leading-relaxed">
              <span class="mr-3 text-2xl">â°</span>
              <span class="font-medium mr-2">ç™¼å¸ƒ:</span>
              <span>${formatRelativeTime(data.createTime)}</span>
            </div>
            ` : ''}
          </div>
          
          ${data.description ? `
          <div class="mb-4 p-4 bg-gray-50 rounded-md">
            <div class="text-lg sm:text-sm font-medium text-gray-700 mb-3">ğŸ“‹ éœ€æ±‚èªªæ˜</div>
            <div class="text-lg sm:text-sm text-gray-600 leading-relaxed">${data.description}</div>
          </div>
          ` : ''}
          
          <div class="mb-4">
            <div class="flex justify-between text-lg sm:text-sm text-gray-600 mb-3">
              <span class="font-medium">ğŸ‘¥ å ±åé€²åº¦</span>
              <span><strong>${data.registered || 0}</strong> / ${data.needed || 'ä¸é™'} äºº</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: ${Math.min(progress, 100)}%"></div>
            </div>
          </div>
          
          <div class="space-y-2 mb-4 text-lg sm:text-sm text-gray-600">
            <div class="flex items-center leading-relaxed">
              <span class="mr-3 text-2xl">ğŸ‘¤</span>
              <span class="font-medium mr-2">è¯çµ¡äºº:</span>
              <span>${data.contact || 'æœªæŒ‡å®š'}</span>
            </div>
            ${data.phone ? `
            <div class="flex items-center leading-relaxed">
              <span class="mr-3 text-2xl">ğŸ“</span>
              <span class="font-medium mr-2">é›»è©±:</span>
              <span>${data.phone}</span>
            </div>
            ` : ''}
          </div>
          
          <button class="w-full py-4 sm:py-2 px-4 rounded-lg font-medium transition-colors text-xl sm:text-sm ${isFull ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white'}" 
                  ${isFull ? 'disabled' : ''} 
                  onclick="alert('å ±ååŠŸèƒ½é–‹ç™¼ä¸­')">
            ${isFull ? 'ğŸš« å·²é¡æ»¿' : 'âœ‹ æˆ‘è¦å ±åç•¶å¿—å·¥'}
          </button>
        </div>
      `;
      
      return card;
    }
    
    // é‡æ–°æ•´ç†è³‡æ–™
    async function refreshData() {
      try {
        const dataResponse = await fetchGASData('data');
        if (dataResponse.success) {
          currentData = dataResponse.data;
          displayData();
        }
      } catch (error) {
        console.error('é‡æ–°æ•´ç†å¤±æ•—:', error);
        alert('é‡æ–°æ•´ç†å¤±æ•—: ' + error.message);
      }
    }
    
    // æ¨¡æ…‹æ¡†å‡½æ•¸ (ç°¡åŒ–ç‰ˆ)
    function openAddRequestModal() {
      alert('æ–°å¢éœ€æ±‚åŠŸèƒ½é–‹ç™¼ä¸­\nè«‹ç›´æ¥ä½¿ç”¨ Google Apps Script ç‰ˆæœ¬');
    }
    
    function openQueryModal() {
      alert('æŸ¥è©¢éœ€æ±‚åŠŸèƒ½é–‹ç™¼ä¸­\nè«‹ç›´æ¥ä½¿ç”¨ Google Apps Script ç‰ˆæœ¬');
    }
    
    // å·¥å…·å‡½æ•¸
    function showLoading() {
      document.getElementById('github-loading').classList.remove('hidden');
      document.getElementById('main-content').classList.add('hidden');
      document.getElementById('error-display').classList.add('hidden');
    }
    
    function hideLoading() {
      document.getElementById('github-loading').classList.add('hidden');
      document.getElementById('main-content').classList.remove('hidden');
    }
    
    function showError(message) {
      document.getElementById('error-message').textContent = message;
      document.getElementById('github-loading').classList.add('hidden');
      document.getElementById('main-content').classList.add('hidden');
      document.getElementById('error-display').classList.remove('hidden');
    }
    
    function retryLoad() {
      loadFromGAS();
    }
    
    // æ ¼å¼åŒ–æ—¥æœŸ (èˆ‡åŸç‰ˆç›¸åŒ)
    function formatDate(date) {
      try {
        if (!date) return 'æœªæŒ‡å®š';
        let d = date;
        if (!(d instanceof Date)) {
          if (typeof date === 'string') {
            d = new Date(date);
          } else {
            d = new Date(date);
          }
        }
        if (isNaN(d.getTime())) return String(date);
        return d.toLocaleString('zh-TW', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: true,
          timeZone: 'Asia/Taipei'
        });
      } catch (e) {
        console.error('formatDate éŒ¯èª¤:', e, date);
        return String(date);
      }
    }
    
    // è§£ææ™‚é–“å­—ä¸² (èˆ‡åŸç‰ˆç›¸åŒ)
    function parseTimeString(timeString) {
      if (!timeString) return new Date(0);
      try {
        if (timeString instanceof Date) {
          return timeString;
        }
        if (typeof timeString === 'string') {
          if (timeString.includes('ä¸Šåˆ') || timeString.includes('ä¸‹åˆ')) {
            let convertedTime = timeString
              .replace('ä¸Šåˆ', 'AM')
              .replace('ä¸‹åˆ', 'PM')
              .replace(/(\d{4})\/(\d{1,2})\/(\d{1,2})/, '$1-$2-$3');
            return new Date(convertedTime);
          } else {
            return new Date(timeString);
          }
        }
        return new Date(0);
      } catch (error) {
        console.error('æ™‚é–“è§£æéŒ¯èª¤:', error, timeString);
        return new Date(0);
      }
    }
    
    // æ ¼å¼åŒ–ç›¸å°æ™‚é–“ (ç°¡åŒ–ç‰ˆ)
    function formatRelativeTime(timeString) {
      try {
        const targetDate = parseTimeString(timeString);
        const now = new Date();
        const diffMs = now.getTime() - targetDate.getTime();
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
        
        if (diffMins < 1) return 'å‰›å‰›';
        if (diffMins < 60) return diffMins + 'åˆ†é˜å‰';
        if (diffHours < 24) return diffHours + 'å°æ™‚å‰';
        if (diffDays < 30) return diffDays + 'å¤©å‰';
        
        return formatDate(targetDate);
      } catch (error) {
        return formatDate(timeString);
      }
    }
    
    // é é¢è¼‰å…¥å®Œæˆå¾Œé–‹å§‹
    document.addEventListener('DOMContentLoaded', function() {
      // æª¢æŸ¥æ˜¯å¦æœ‰è¨­å®š API URL
      if (GAS_API_URL === 'YOUR_GAS_WEB_APP_URL_HERE') {
        showError('è«‹å…ˆè¨­å®š GAS_API_URL\nåœ¨ç¨‹å¼ç¢¼ä¸­å°‡ YOUR_GAS_WEB_APP_URL_HERE æ›¿æ›ç‚ºä½ çš„ Google Apps Script Web App URL');
        return;
      }
      
      loadFromGAS();
    });
  </script>
</body>
</html>